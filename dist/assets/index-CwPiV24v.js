(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function e(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(o){if(o.ep)return;o.ep=!0;const a=e(o);fetch(o.href,a)}})();const Jt=document.getElementById("app");Jt.innerHTML=`
  <div id="hero" style="position: relative; text-align: center;">
    <h2>Receipt and Claim Scanner</h2>
    <div id="start-controls" style="margin-top: 12px; display: inline-flex; gap: 12px;">
      <label class="icon-button" title="Upload Images/PDFs">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 3v10" stroke="#111" stroke-width="2"/><path d="M8 7l4-4 4 4" stroke="#111" stroke-width="2"/><path d="M4 14v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4" stroke="#111" stroke-width="2"/></svg>
        <input type="file" id="fileInput" accept="image/*,application/pdf" multiple style="display:none" />
      </label>
      <button id="startCamera" class="icon-button" title="Use Camera">
        <svg viewBox="0 0 24 24" fill="none"><rect x="3" y="7" width="18" height="12" rx="3" stroke="#111" stroke-width="2"/><path d="M9 7l1.5-2h3L15 7" stroke="#111" stroke-width="2"/><circle cx="12" cy="13" r="3" stroke="#111" stroke-width="2"/></svg>
      </button>
      <button id="openSettings" class="icon-button" title="Settings">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z" stroke="#111" stroke-width="2"/><path d="M4 12h2m12 0h2M12 4v2m0 12v2" stroke="#111" stroke-width="2"/></svg>
      </button>
    </div>
  </div>
  <div id="content">
    <div id="start">
      <div id="camera" style="display:none; position: relative;">
        <video id="video" autoplay playsinline></video>
        <button id="captureOverlay" style="display:none">Capture</button>
        <button id="toggleTorch" class="camera-toolbar-button" title="Toggle Light" style="display:none" aria-label="Toggle Light">
          <svg viewBox="0 0 24 24" fill="none"><path d="M7 3h10l-2 5H9L7 3Z" stroke="#111" stroke-width="2"/><rect x="10" y="9" width="4" height="10" rx="1" stroke="#111" stroke-width="2"/><path d="M12 19v2" stroke="#f59e0b" stroke-width="2"/></svg>
        </button>
        <div id="torchIndicator" class="torch-indicator">Light: Off</div>
      </div>
      <div id="results" style="display:none">Select or capture images to see border detection results</div>
      <div id="claimsCount" class="count-pill"></div>
      <div id="alertBar" class="alert-bar"></div>
      <div id="claimsList" class="mobile-list"></div>
      <div id="claimEditor" class="claim-editor" style="display:none"></div>
      <div id="action-controls">
        <button id="exportPdf" class="control-button">Export to PDF</button>
        <button id="exportCsv" class="control-button">Export CSV</button>
        <button id="sendEmail" class="control-button" style="display:none">Send Email</button>
      </div>
    </div>
  </div>

  <div id="processingOverlay" class="processing-overlay"><div class="spinner"></div><div id="processingStatus">Processing...</div><div id="processingLogs" class="logs"></div></div>

  <div id="settingsPanel" class="settings-panel">
    <div class="header">
      <div>Settings</div>
      <button id="closeSettings">Close</button>
    </div>
    <div class="content">
      <div class="llm-field">
        <label>LLM Endpoint</label>
        <input type="text" id="settingsEndpoint" />
      </div>
      <div class="llm-field">
        <label>Model</label>
        <input type="text" id="settingsModel" />
      </div>
      <div class="llm-field">
        <label>API Key</label>
        <input type="password" id="settingsApiKey" placeholder="Enter API key" />
      </div>
      <div class="llm-field">
        <label>Extract Height (px)</label>
        <input type="number" id="settingsExtractHeight" min="500" step="100" />
      </div>
      <div class="llm-field">
        <label>Camera Width (px)</label>
        <input type="number" id="settingsCamWidth" min="640" step="160" />
      </div>
      <div class="llm-field">
        <label>Camera Height (px)</label>
        <input type="number" id="settingsCamHeight" min="480" step="120" />
      </div>
      <div class="llm-field">
        <label>SMTP Host</label>
        <input type="text" id="settingsSmtpHost" style="display:none" />
      </div>
      <div class="llm-field">
        <label>SMTP Port</label>
        <input type="number" id="settingsSmtpPort" min="1" style="display:none" />
      </div>
      <div class="llm-field">
        <label>SMTP Username</label>
        <input type="text" id="settingsSmtpUser" style="display:none" />
      </div>
      <div class="llm-field">
        <label>SMTP Password</label>
        <input type="password" id="settingsSmtpPass" style="display:none" />
      </div>
      <div class="llm-field">
        <label>From Email</label>
        <input type="email" id="settingsSmtpFrom" style="display:none" />
      </div>
      <div class="llm-field">
        <label>To Email</label>
        <input type="email" id="settingsSmtpTo" style="display:none" />
      </div>
      <div class="llm-field">
        <label>Email Subject</label>
        <input type="text" id="settingsSmtpSubject" style="display:none" />
      </div>
      <div class="llm-field">
        <label>SMTP Secure Token (smtpjs)</label>
        <input type="text" id="settingsSmtpToken" placeholder="Optional: use smtpjs SecureToken" style="display:none" />
      </div>
      <div class="llm-field">
        <label>Email API Endpoint (preferred)</label>
        <input type="text" id="settingsEmailApiEndpoint" placeholder="https://your-service/send" style="display:none" />
      </div>
      <div class="llm-field">
        <label>Email API Key (Bearer)</label>
        <input type="text" id="settingsEmailApiKey" placeholder="Optional API key/token" style="display:none" />
      </div>
    </div>
    <div class="actions">
      <button id="saveSettings" class="primary">Save</button>
      <button id="testSmtp">Test SMTP</button>
      <button id="cancelSettings">Cancel</button>
    </div>
  </div>
`;let jt=!1;const Vt="https://docs.opencv.org/4.7.0/opencv.js";function lt(n){if(jt)n();else{const t=document.createElement("script");t.src=Vt,t.onload=function(){setTimeout(n,1e3),jt=!0},document.body.appendChild(t)}}const at=new window.jscanify;function $t(n){if(window.jspdf&&window.jspdf.jsPDF)n();else{const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js",t.onload=n,document.body.appendChild(t)}}function ht(n){if(window.Tesseract)n();else{const t=document.createElement("script");t.src="https://unpkg.com/tesseract.js@v4/dist/tesseract.min.js",t.onload=n,document.body.appendChild(t)}}function Ht(n){if(window.Email&&window.Email.send)n();else{const t=document.createElement("script");t.src="https://smtpjs.com/v3/smtp.js",t.onload=n,t.onerror=function(){_("Failed to load SMTP library"),n()},document.body.appendChild(t)}}function Rt(n){if(window.pdfjsLib&&window.pdfjsLib.getDocument)n();else{const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",t.onload=function(){try{window.pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"}catch{}n()},document.body.appendChild(t)}}function Gt(){return window.crypto&&window.crypto.randomUUID?"claim-"+window.crypto.randomUUID():"claim-"+Date.now()+"-"+Math.random().toString(36).slice(2,8)}function Ct(n){try{let e=n.width,i=n.height;const o=Math.min(1,1600/Math.max(e,i));if(o<1){const a=document.createElement("canvas");return a.width=Math.round(e*o),a.height=Math.round(i*o),a.getContext("2d").drawImage(n,0,0,a.width,a.height),a.toDataURL("image/jpeg",.8)}return n.toDataURL("image/jpeg",.8)}catch{return n.toDataURL("image/jpeg",.8)}}function vt(n){try{if(!window.cv)return n;const t=cv.imread(n),e=new cv.Mat;cv.cvtColor(t,e,cv.COLOR_RGBA2GRAY);const i=new cv.Mat;cv.GaussianBlur(e,i,new cv.Size(3,3),0,0,cv.BORDER_DEFAULT);const o=new cv.Mat;cv.threshold(i,o,0,255,cv.THRESH_BINARY|cv.THRESH_OTSU);const a=cv.getStructuringElement(cv.MORPH_RECT,new cv.Size(2,2)),c=new cv.Mat;cv.morphologyEx(o,c,cv.MORPH_CLOSE,a);let s=new cv.Mat;const d=1800,r=c.cols,m=c.rows,g=Math.min(1,d/Math.max(r,m));if(g<1){const h=new cv.Size(Math.round(r*g),Math.round(m*g));cv.resize(c,s,h,0,0,cv.INTER_AREA)}else s=c.clone();const l=document.createElement("canvas");return l.width=s.cols,l.height=s.rows,cv.imshow(l,s),t.delete(),e.delete(),i.delete(),o.delete(),a.delete(),c.delete(),s.delete(),l}catch{return n}}function gt(n){const t=at.findPaperContour(cv.imread(n));if(!t)return null;const e=at.getCornerPoints(t),i=e.topLeftCorner,o=e.topRightCorner,a=e.bottomLeftCorner,c=e.bottomRightCorner;if(!i||!o||!a||!c)return null;const s=Math.hypot(i.x-o.x,i.y-o.y),d=Math.hypot(a.x-c.x,a.y-c.y),r=Math.hypot(i.x-a.x,i.y-a.y),m=Math.hypot(o.x-c.x,o.y-c.y),g=Math.max(s,d),l=Math.max(r,m);if(!g||!l)return null;const h=ot(),v=parseInt(h.extractHeight||"2000"),b=Math.round(v);return{resultWidth:Math.max(1,Math.round(g/l*v)),resultHeight:b,cornerPoints:e}}let Y,Z=!1;const Bt=["merchant_name","merchant_address","transaction_date","transaction_time","total_amount","currency","local_amount","invoice_number","description","type_claim","purpose"],Mt=["Broadband","Car Maintenance","Car Rental","Computer","Company Admin","Domain","Entertainment","Gift","Leave Passage","Medical","Mobile Plan","Outsourcing","Parking","Software","Stationery","Subscription","Transport","Travel (Hotel)","Travel (Air ticket)","Web Services"],Dt="jscanify_claims",Ft="jscanify_llm_config",Ut="jscanify_smtp_config";function u(n){try{const t=document.getElementById("processingLogs");if(t){const e=document.createElement("div");e.textContent=n,t.appendChild(e),t.scrollTop=t.scrollHeight}}catch{}}function _(n){try{const t=document.getElementById("alertBar");if(!t)return;t.innerHTML="";const e=document.createElement("div");e.className="alert",e.textContent=n,t.appendChild(e),setTimeout(function(){t.contains(e)&&(t.innerHTML="")},6e3)}catch{}}function Wt(){try{return JSON.parse(localStorage.getItem(Ut)||"{}")}catch{return{}}}function Yt(n){localStorage.setItem(Ut,JSON.stringify(n))}$(function(){function n(){$("#processingOverlay").show(),$("#processingLogs").empty(),$("#processingStatus").text("Processing...")}function t(){$("#processingOverlay").hide()}$("#fileInput").on("change",function(e){const i=Array.from(e.target.files||[]);if(!i.length)return;const o=i.filter(function(s){return/\.pdf$/i.test(s.name)||(s.type||"").toLowerCase()==="application/pdf"}),a=i.filter(function(s){return!o.includes(s)});n(),u("Reading "+i.length+" file(s)");let c=o.length+a.length;a.length&&lt(function(){a.forEach(function(s){const d=document.createElement("img");d.src=URL.createObjectURL(s),d.onload=function(){u("Loaded image: "+(s.name||"blob"));const r=gt(d);u(r?"Detected document edges":"No document detected");const m=r?at.extractPaper(d,r.resultWidth,r.resultHeight,r.cornerPoints):null;if(m){u("Extracted document");const g=Nt(m);At(m,g).finally(function(){c--,c===0&&t()})}else c--,c===0&&t()}})}),o.length&&Rt(function(){o.forEach(function(s){te(s).finally(function(){c--,c===0&&t()})})})}),$("#startCamera").on("click",async function(){lt(function(){});try{const e=ot(),i=parseInt(e.camWidth||"1920"),o=parseInt(e.camHeight||"1080");Y=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:i},height:{ideal:o}}});const a=document.getElementById("video");a.srcObject=Y,$("#camera").show(),$("#captureOverlay").prop("disabled",!0).show();const c=Y.getVideoTracks&&Y.getVideoTracks()[0];try{const s=c&&c.getCapabilities?c.getCapabilities():{};s&&s.torch?($("#toggleTorch").show(),$("#torchIndicator").show().text("Light: Off"),Z=!1):($("#toggleTorch").hide(),$("#torchIndicator").hide(),Z=!1)}catch{$("#toggleTorch").hide(),$("#torchIndicator").hide(),Z=!1}a.onloadedmetadata=function(){$("#captureOverlay").prop("disabled",!1)}}catch(e){$("#results").text("Camera error: "+(e&&e.message?e.message:e))}}),$("#captureOverlay").on("click",function(){n(),u("Capturing photo from camera");const e=document.getElementById("video");if(!e.videoWidth||!e.videoHeight){u("Camera not ready"),t();return}const i=document.createElement("canvas");i.width=e.videoWidth,i.height=e.videoHeight,i.getContext("2d").drawImage(e,0,0,i.width,i.height),Y&&(Y.getTracks().forEach(function(a){a.stop()}),Y=null),$("#camera").hide(),$("#captureOverlay").hide(),$("#toggleTorch").hide(),$("#torchIndicator").hide(),Z=!1,lt(function(){try{u("Detecting document edges");const a=gt(i),c=a?at.extractPaper(i,a.resultWidth,a.resultHeight,a.cornerPoints):null;if(c){u("Extracted document");const s=Nt(c);At(c,s).finally(function(){t()})}else{t();const s=document.createElement("div");s.textContent="No document detected in capture.",$("#results").append(s)}}catch(a){u("Error: "+(a&&a.message?a.message:String(a))),t()}})}),$("#toggleTorch").on("click",async function(){try{const e=Y&&Y.getVideoTracks&&Y.getVideoTracks()[0];if(!e){_("No active camera stream");return}if(!(e.getCapabilities?e.getCapabilities():{}).torch){_("Torch not supported on this device");return}Z=!Z,await e.applyConstraints({advanced:[{torch:Z}]}),$("#torchIndicator").text(Z?"Light: On":"Light: Off"),Z?$("#toggleTorch").addClass("on"):$("#toggleTorch").removeClass("on")}catch{Z=!1,$("#torchIndicator").text("Light: Off"),$("#toggleTorch").removeClass("on"),_("Failed to toggle torch")}}),$("#exportPdf").on("click",function(){const e=K().filter(function(i){return!!i.image_data||i.pdf_pages&&i.pdf_pages.length||i.support_docs&&i.support_docs.length});if(!e.length){alert("No items to export");return}$t(async function(){const{jsPDF:i}=window.jspdf,o=new i({unit:"pt",format:"a4",orientation:"portrait"}),a=o.internal.pageSize,c=a.getWidth(),s=a.getHeight(),d=24,r=10,m=(c-d*2)*.45,g=(s-d*2)*.42;let l=d,h=d,v=0;async function b(k,P){return new Promise(function(F){const T=new Image;T.onload=function(){let N=T.naturalWidth,M=T.naturalHeight;const tt=Math.min(m/N,g/M,1);N*=tt,M*=tt;const y=14;l+N>c-d&&(l=d,h+=v+r,v=0),h+M+y>s-d&&(o.addPage("a4","portrait"),l=d,h=d,v=0);const j=k.startsWith("data:image/jpeg")?"JPEG":"PNG";o.addImage(k,j,l,h,N,M),P&&(o.setFontSize(10),o.setTextColor(55),o.text(String(P),l,h+M+12,{maxWidth:m})),l+=N+r,v=Math.max(v,M+y),F()},T.src=k})}for(const k of e){const P=k.pdf_pages&&k.pdf_pages.length?k.pdf_pages:k.image_data?[k.image_data]:[];if(P.length)if(P.length===1)await b(P[0]," "+(k.transaction_date||"")+", Pg 1");else for(let T=0;T<P.length;T++)await b(P[T]," "+(k.transaction_date||"")+", Pg "+(T+1)+" of "+P.length);const F=Array.isArray(k.support_docs)?k.support_docs:[];for(let T=0;T<F.length;T++){const N=F[T];if(Array.isArray(N.pdf_pages)&&N.pdf_pages.length)for(let M=0;M<N.pdf_pages.length;M++)await b(N.pdf_pages[M],"Support Pg "+(M+1)+" of "+N.pdf_pages.length);else await b(N.processed_url||N.original_url,"Support Pg 1")}}o.save("jscanify.pdf")})}),$("#exportCsv").on("click",function(){const e=K();if(!e.length){alert("No items to export");return}const i=new Set(["_id","datetime_added","merchant_address","page_count","tyoe_claim","source_id","image_data","pdf_pages"]),o=new Set;e.forEach(function(l){Object.keys(l).forEach(function(h){i.has(h)||o.add(h)})});const a=["merchant_name","transaction_date","transaction_time","currency","total_amount","local_amount","type_claim","purpose"],c=a.filter(function(l){return o.has(l)||l==="type_claim"}).concat(Array.from(o).filter(function(l){return a.indexOf(l)===-1})),s=[];s.push(c.join(",")),e.forEach(function(l){s.push(c.map(function(h){let v=l[h];return h==="type_claim"&&(v==null||v==="")&&(v=l.tyoe_claim),'"'+(v==null?"":String(v).replace(/"/g,'""'))+'"'}).join(","))});const d=s.join(`
`),r=new Blob([d],{type:"text/csv;charset=utf-8"}),m=URL.createObjectURL(r),g=document.createElement("a");g.href=m,g.download="jscanify.csv",document.body.appendChild(g),g.click(),setTimeout(function(){URL.revokeObjectURL(m),g.remove()},500)}),$("#sendEmail").on("click",async function(){const e=Wt();if(!e.apiEndpoint&&!e.token&&(!e.host||!e.port||!e.user||!e.pass||!e.from||!e.to)){_("Set Email API or SMTP settings first");return}const i=K().filter(function(o){return!!o.image_data||o.pdf_pages&&o.pdf_pages.length});if(!i.length){alert("No items to send");return}n(),u("Preparing attachments"),$t(async function(){const{jsPDF:o}=window.jspdf,a=new o({unit:"pt",format:"a4",orientation:"portrait"}),c=a.internal.pageSize,s=c.getWidth(),d=c.getHeight(),r=24,m=10,g=(s-r*2)*.45,l=(d-r*2)*.45;let h=r,v=r,b=0;async function k(y){return new Promise(function(j){const I=new Image;I.onload=function(){let D=I.naturalWidth,H=I.naturalHeight;const U=Math.min(g/D,l/H,1);D*=U,H*=U,h+D>s-r&&(h=r,v+=b+m,b=0),v+H>d-r&&(a.addPage("a4","portrait"),h=r,v=r,b=0);const J=y.startsWith("data:image/jpeg")?"JPEG":"PNG";a.addImage(y,J,h,v,D,H),h+=D+m,b=Math.max(b,H),j()},I.src=y})}for(const y of i){const j=y.pdf_pages&&y.pdf_pages.length?y.pdf_pages:[y.image_data];for(const I of j)await k(I)}const P=a.output("datauristring");u("Preparing CSV");const F=Array.from(i.reduce(function(y,j){return Object.keys(j).forEach(function(I){I!=="image_data"&&I!=="pdf_pages"&&y.add(I)}),y},new Set)),T=[];T.push(F.join(",")),i.forEach(function(y){T.push(F.map(function(j){const I=y[j];return'"'+(I==null?"":String(I).replace(/"/g,'""'))+'"'}).join(","))});const N=T.join(`
`),M="data:text/csv;base64,"+btoa(unescape(encodeURIComponent(N)));async function tt(){try{const y=new AbortController,j=setTimeout(function(){y.abort()},25e3),I={to:e.to,from:e.from,subject:e.subject||"Receipts",text:"Attached PDF and CSV exported from Melvin Scanner.",attachments:[{filename:"claims.pdf",content:P},{filename:"claims.csv",content:M}]},D={"Content-Type":"application/json"};e.apiKey&&(D.Authorization="Bearer "+e.apiKey);const H=await fetch(e.apiEndpoint,{method:"POST",headers:D,body:JSON.stringify(I),signal:y.signal});return clearTimeout(j),H.ok?(u("Email sent via API"),_("Email sent successfully"),!0):(u("Email API failed: "+H.status),_("Email API failed: "+H.status),!1)}catch(y){return u("Email API error: "+(y&&y.message?y.message:String(y))),_("Email send failed or timed out"),!1}}if(e.apiEndpoint){u("Sending via Email API"),await tt(),t();return}Ht(async function(){u("Sending via SMTP");async function y(D){return new Promise(function(H){let U=!1;function J(R){U||(U=!0,H(R))}const w=setTimeout(function(){J(!1)},D);try{const R=e.token?{SecureToken:e.token,To:e.to,From:e.from,Subject:e.subject||"Receipts",Body:"Attached PDF and CSV exported from Melvin Scanner.",Attachments:[{name:"claims.pdf",data:P},{name:"claims.csv",data:M}]}:{Host:e.host,Port:e.port,Username:e.user,Password:e.pass,To:e.to,From:e.from,Subject:e.subject||"Receipts",Body:"Attached PDF and CSV exported from Melvin Scanner.",Attachments:[{name:"claims.pdf",data:P},{name:"claims.csv",data:M}]};window.Email.send(R).then(function(){clearTimeout(w),J(!0)}).catch(function(){clearTimeout(w),J(!1)})}catch{clearTimeout(w),J(!1)}})}const j=(P.length+M.length)*3/(4*1024*1024);j>8&&(u("Warning: large attachments ~"+j.toFixed(2)+"MB"),_("Attachments are large; sending may fail or time out")),await y(25e3)?(u("Email sent"),_("Email sent successfully")):(u("Email timeout or failed"),_("Email send failed or timed out")),t()})})}),$("#processOcr").on("click",async function(){const e=Array.from(document.querySelectorAll("#results .result-item"));if(!e.length){$("#results").prepend($("<div>").text("No results to process"));return}n(),u("Processing "+e.length+" result(s)");const{endpoint:i,model:o,apiKey:a}=ot();if(!i||!o||!a){alert("Set LLM settings first");return}ht(async function(){try{const c=[];for(const s of e){const d=s.querySelector("canvas"),r=Ct(d);u("Enhancing image for OCR");const m=vt(d);u("Running OCR");const l=(await window.Tesseract.recognize(m,"eng")).data.text;u("Calling LLM to extract fields");const h=await yt(i,o,a,l);if(h){const v=wt(h),b=it(v,s.dataset.id,r);c.push(b)}else{const v=it({},s.dataset.id,r);v.status="unsuccessful",c.push(v)}}u("Saving to Local Storage");try{ft(c)}catch(s){u("Storage error: "+(s&&s.message?s.message:String(s)))}c.length&&u("New claim id(s): "+c.map(function(s){return s._id}).join(", ")),u("Claims count: "+K().length),u("Updating list");try{Q()}catch(s){u("Render error: "+(s&&s.message?s.message:String(s)))}u("Done")}finally{t()}})})});async function yt(n,t,e,i){const o=`Extract receipt fields as strict JSON with keys: merchant_name, merchant_address, transaction_date, transaction_time, total_amount, currency, local_amount, invoice_number, description, type_claim, purpose.
Formatting: transaction_date as dd/mm/yyyy; transaction_time as hh:mm:ss (24h); total_amount as number with 2 decimals; currency as uppercase string. Map invoice_number from invoice/order/receipt number labels if present (e.g., Invoice No, Order #, Receipt). description should be a concise item/transaction description.
Choose type_claim closest to the description from this list: `+JSON.stringify(Mt)+`. If unclear, set type_claim to null.
Provide purpose as a short summary (6–12 words). If missing, set purpose to null. Output only JSON.`,a={model:t,messages:[{role:"system",content:"You are a parser that outputs only JSON."},{role:"user",content:o+`

Receipt OCR:
`+i}],response_format:{type:"json_object"}};try{const c=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e},body:JSON.stringify(a)});if(!c.ok)return _("LLM call failed ("+c.status+"). Check API key/model/endpoint."),null;const s=await c.json(),d=s.choices&&s.choices[0]&&s.choices[0].message&&s.choices[0].message.content;return d?JSON.parse(d):null}catch(c){return _("LLM error: "+(c&&c.message?c.message:String(c))),null}}function wt(n){const t=Object.assign({},n||{});function e(r){return String(r).padStart(2,"0")}const i=t.transaction_date;if(typeof i=="string"){const r=i.match(/^([0-3]?\d)[\/-]([0-1]?\d)[\/-](\d{4})$/);if(r)t.transaction_date=e(r[1])+"/"+e(r[2])+"/"+r[3];else{const m=Date.parse(i);if(!isNaN(m)){const g=new Date(m);t.transaction_date=e(g.getDate())+"/"+e(g.getMonth()+1)+"/"+g.getFullYear()}}}const o=t.transaction_time;if(typeof o=="string"){const r=o.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?$/i);if(r){let m=parseInt(r[1],10);const g=e(r[2]),l=e(r[3]||"00"),h=r[4];if(h){const v=h.toUpperCase()==="PM";v&&m<12&&(m+=12),!v&&m===12&&(m=0)}t.transaction_time=e(m)+":"+g+":"+l}}const a=t.total_amount;if(a!=null&&a!==""){const r=parseFloat(a);isNaN(r)||(t.total_amount=r.toFixed(2))}const c=t.local_amount;if(c!=null&&c!==""){const r=parseFloat(c);isNaN(r)||(t.local_amount=r.toFixed(2))}t.total_amount!=null&&t.total_amount!==""&&(t.local_amount==null||t.local_amount==="")&&(t.local_amount=t.total_amount);let s=t.currency;s==null||String(s).trim()===""||String(s).toUpperCase()==="RM"||String(s).toUpperCase()==="UNKNOWN"?t.currency="MYR":t.currency=String(s).toUpperCase(),t.tyoe_claim&&!t.type_claim&&(t.type_claim=t.tyoe_claim,delete t.tyoe_claim),t.type_claim&&!Mt.includes(t.type_claim)&&(t.type_claim=t.type_claim);function d(r){if(!r)return"";const m=String(r).toLowerCase(),g=[{type:"Broadband",kw:["broadband","fiber","internet","wifi"]},{type:"Mobile Plan",kw:["mobile","cell","sim","data plan","telco"]},{type:"Transport",kw:["taxi","grab","uber","bus","train","transport","fuel","petrol"]},{type:"Parking",kw:["parking","park"]},{type:"Travel (Hotel)",kw:["hotel","accommodation","lodging"]},{type:"Travel (Air ticket)",kw:["flight","air ticket","airline"]},{type:"Software",kw:["software","license","subscription","saas"]},{type:"Subscription",kw:["subscription","renewal","monthly","annual"]},{type:"Stationery",kw:["stationery","pen","paper","notebook"]},{type:"Web Services",kw:["domain","hosting","server","cloud","dns","ssl","web"]},{type:"Computer",kw:["laptop","desktop","monitor","keyboard","mouse","ssd","ram"]},{type:"Car Maintenance",kw:["service","maintenance","car","tyre","battery"]},{type:"Car Rental",kw:["car rental","rent-a-car","vehicle rental"]},{type:"Medical",kw:["clinic","medical","doctor","pharmacy"]},{type:"Entertainment",kw:["meal","restaurant","food","entertainment","coffee"]},{type:"Company Admin",kw:["admin","stamp","government","fee"]},{type:"Gift",kw:["gift","present"]},{type:"Outsourcing",kw:["outsource","contractor","freelance","service fee"]}];for(const l of g)if(l.kw.some(function(h){return m.indexOf(h)!==-1}))return l.type;return""}if((!t.type_claim||String(t.type_claim).trim()==="")&&t.description){const r=d(t.description);r&&(t.type_claim=r)}if(t.description){const r=String(t.description).toLowerCase();(r.indexOf("restaurant")!==-1||r.indexOf("food")!==-1||r.indexOf("meal")!==-1||r.indexOf("dining")!==-1||r.indexOf("cafe")!==-1||r.indexOf("coffee")!==-1)&&(t.type_claim="Entertainment")}if((!t.purpose||String(t.purpose).trim()==="")&&t.description){const r=String(t.description).trim().replace(/\s+/g," ").split(" ");t.purpose=r.slice(0,12).join(" ")}return t}function At(n,t){const{endpoint:e,model:i,apiKey:o}=ot();return new Promise(function(a){const c=Ct(n);if(!e||!i||!o){u("LLM settings missing; saving image without parsed fields");const s=it({},t,c);s.status="pending";try{ft([s])}catch{}try{Q()}catch{}_("LLM settings missing. Saved image; no fields parsed."),a();return}ht(async function(){try{u("Enhancing image for OCR");const s=vt(n);u("Running OCR");const r=(await window.Tesseract.recognize(s,"eng")).data.text;u("Calling LLM to extract fields");const m=await yt(e,i,o,r);let g;if(m){const l=wt(m);g=it(l,t,c)}else g=it({},t,c),g.status="unsuccessful",_("LLM parsing failed. Check model and endpoint settings.");u("Saving to Local Storage");try{ft([g])}catch(l){u("Storage error: "+(l&&l.message?l.message:String(l)))}u("New claim id: "+g._id),u("Claims count: "+K().length),u("Updating list");try{Q()}catch(l){u("Render error: "+(l&&l.message?l.message:String(l)))}u("Done")}catch(s){u("Error: "+(s&&s.message?s.message:String(s))),_("OCR/LLM error: "+(s&&s.message?s.message:String(s)))}finally{a()}})})}function it(n,t,e){const i={};return Bt.forEach(function(o){i[o]=n&&n[o]!=null?n[o]:""}),i._id=Gt(),t&&(i.source_id=t),e&&(i.image_data=e),i.datetime_added||(i.datetime_added=new Date().toISOString()),i}let Zt=1;function Nt(n){const t=String(Zt++),e=document.createElement("div");e.className="result-item",e.dataset.id=t;const i=document.createElement("button");i.className="remove-btn",i.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M3 6h18" stroke="#333" stroke-width="2"/><path d="M8 6V4h8v2" stroke="#333" stroke-width="2"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" stroke="#333" stroke-width="2"/><path d="M10 11v7" stroke="#333" stroke-width="2"/><path d="M14 11v7" stroke="#333" stroke-width="2"/></svg>',i.addEventListener("click",function(){e.remove(),qt(t),Q()}),e.appendChild(i),e.appendChild(n);const o=document.getElementById("results");return o.childElementCount===0&&(o.innerHTML=""),o.appendChild(e),t}function K(){try{const n=JSON.parse(localStorage.getItem(Dt)||"[]");let t=!1;const e=n.map(function(i){return i._id||(i._id="claim-"+(i.datetime_added?Date.parse(i.datetime_added):Date.now())+"-"+Math.random().toString(36).slice(2,8),t=!0),i.datetime_added||(i.datetime_added=new Date().toISOString(),t=!0),i.tyoe_claim&&!i.type_claim&&(i.type_claim=i.tyoe_claim,delete i.tyoe_claim,t=!0),i});return t&&X(e),e}catch{return[]}}function X(n){localStorage.setItem(Dt,JSON.stringify(n))}function q(n){return n&&n._id}function qt(n){const e=K().filter(function(i){return i.source_id!==n&&q(i)!==n});X(e)}function ft(n){const t=K(),e=new Map;t.forEach(function(i){i&&i._id&&e.set(i._id,i)}),n.forEach(function(i){i&&i._id&&e.set(i._id,i)}),X(Array.from(e.values()))}function Q(){const n=K(),t=document.getElementById("claimsCount"),e=n.reduce(function(o,a){const c=parseFloat(a.local_amount);return o+(isNaN(c)?0:c)},0);t&&(t.innerHTML="Items: "+n.length+" · Local Total: MYR "+e.toFixed(2)+' <button id="clearList" class="pill-action">Clear List</button>'),$("#clearList").off("click").on("click",function(){window.confirm("Clear all saved items?")&&(X([]),Q())}),n.sort(function(o,a){const c=o&&o.datetime_added?Date.parse(o.datetime_added):0;return(a&&a.datetime_added?Date.parse(a.datetime_added):0)-c});const i=document.getElementById("claimsList");i.innerHTML="",n.forEach(function(o){const a=document.createElement("div");a.className="mobile-card",a.dataset.id=q(o);const c=document.createElement("div");c.className="text";const s=document.createElement("div");s.className="title";const d=(o.purpose||"").trim(),r=(o.merchant_name||"").trim();if(s.textContent=d&&r?d+" - "+r:d||r||"Receipt",o.status==="unsuccessful"){const k=document.createElement("span");k.className="badge error",k.textContent="Unsuccessful Scan",s.appendChild(k)}const m=document.createElement("div");m.className="subtitle";const g=parseFloat(o.local_amount!=null&&o.local_amount!==""?o.local_amount:o.total_amount),l=o.currency||"MYR";m.textContent=isNaN(g)?"":l+" "+g.toFixed(2);const h=document.createElement("div");h.className="meta";const v=o.datetime_added?new Date(o.datetime_added).toLocaleString():"";h.textContent=v+(o.transaction_date?" · "+o.transaction_date:""),c.appendChild(s),c.appendChild(m),c.appendChild(h);const b=document.createElement("div");b.className="chevron",b.textContent="›",a.appendChild(c),a.appendChild(b),a.addEventListener("click",function(){Qt(o)}),i.appendChild(a)})}function Qt(n){const t=document.getElementById("claimEditor");t.style.display="block",t.innerHTML="";const e=document.createElement("div");e.className="claim-header";const i=document.createElement("div");i.className="title",i.textContent="Edit Claim";const o=document.createElement("div");o.className="actions";const a=document.createElement("button");a.innerHTML='<svg viewBox="0 0 24 24" fill="none" style="width:18px;height:18px;vertical-align:middle;margin-right:6px"><path d="M6 6l12 12M18 6L6 18" stroke="#111" stroke-width="2"/></svg> Close';const c=document.createElement("button");c.className="icon-btn",c.title="Delete",c.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M3 6h18" stroke="#111" stroke-width="2"/><path d="M8 6V4h8v2" stroke="#111" stroke-width="2"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" stroke="#111" stroke-width="2"/><path d="M10 11v7" stroke="#111" stroke-width="2"/><path d="M14 11v7" stroke="#111" stroke-width="2"/></svg>',o.appendChild(c),o.appendChild(a),e.appendChild(i),e.appendChild(o),t.appendChild(e);const s=document.createElement("div");s.className="claim-content";const d=document.createElement("div");d.className="claim-image";const r=document.createElement("div");r.className="nav-controls";const m=document.createElement("button");m.className="icon-btn",m.title="Previous",m.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="#111" stroke-width="2"/></svg>';const g=document.createElement("button");g.className="icon-btn",g.title="Next",g.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M9 6l6 6-6 6" stroke="#111" stroke-width="2"/></svg>';const l=document.createElement("div");l.style.minWidth="80px",l.style.textAlign="center";const h=document.createElement("canvas"),v=h.getContext("2d");d.appendChild(h);const b=document.createElement("div");b.className="img-controls";const k=document.createElement("button");k.className="icon-btn",k.title="Zoom Out",k.innerHTML='<svg viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="6" stroke="#111" stroke-width="2"/><path d="M21 21l-4.35-4.35" stroke="#111" stroke-width="2"/><path d="M8 11h6" stroke="#111" stroke-width="2"/></svg>';const P=document.createElement("button");P.className="icon-btn",P.title="Zoom In",P.innerHTML='<svg viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="6" stroke="#111" stroke-width="2"/><path d="M21 21l-4.35-4.35" stroke="#111" stroke-width="2"/><path d="M11 8v6" stroke="#111" stroke-width="2"/><path d="M8 11h6" stroke="#111" stroke-width="2"/></svg>';const F=document.createElement("button");F.className="icon-btn",F.title="Rotate Left",F.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M12 4v4l-3-3" stroke="#111" stroke-width="2"/><path d="M20 12a8 8 0 1 1-8-8" stroke="#111" stroke-width="2"/></svg>';const T=document.createElement("button");T.className="icon-btn",T.title="Rotate Right",T.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M12 4v4l3-3" stroke="#111" stroke-width="2"/><path d="M4 12a8 8 0 1 0 8-8" stroke="#111" stroke-width="2"/></svg>';const N=document.createElement("span");N.innerHTML='<svg viewBox="0 0 24 24" fill="none" style="width:18px;height:18px;vertical-align:middle;margin-right:4px"><circle cx="12" cy="12" r="8" stroke="#111" stroke-width="2"/><path d="M12 4v16" stroke="#111" stroke-width="2"/></svg> Contrast';const M=document.createElement("input");M.type="range",M.min="0.5",M.max="2.0",M.step="0.1",M.value="1.0",M.className="slider";const tt=document.createElement("span");tt.innerHTML='<svg viewBox="0 0 24 24" fill="none" style="width:18px;height:18px;vertical-align:middle;margin-right:4px"><circle cx="12" cy="12" r="3" stroke="#111" stroke-width="2"/><path d="M12 2v3M12 19v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M2 12h3M19 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12" stroke="#111" stroke-width="2"/></svg> Brightness';const y=document.createElement("input");y.type="range",y.min="-0.5",y.max="0.5",y.step="0.1",y.value="0.0",y.className="slider";const j=document.createElement("button");j.className="icon-btn",j.title="Sharpen",j.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M12 3l2.5 5H19l-4 3 1.5 5-4.5-3-4.5 3L9 11 5 8h4.5L12 3Z" stroke="#111" stroke-width="2"/></svg>';const I=document.createElement("button");I.className="icon-btn",I.title="Reset",I.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M4 4v6h6" stroke="#111" stroke-width="2"/><path d="M20 20a8 8 0 1 0-8-8" stroke="#111" stroke-width="2"/></svg>',b.appendChild(k),b.appendChild(P),b.appendChild(F),b.appendChild(T),b.appendChild(N),b.appendChild(M),b.appendChild(tt),b.appendChild(y),b.appendChild(j),b.appendChild(I);const D=document.createElement("div"),H=document.createElement("button");H.className="primary",H.innerHTML='<svg viewBox="0 0 24 24" fill="none" style="width:18px;height:18px;vertical-align:middle;margin-right:6px"><rect x="3" y="7" width="18" height="12" rx="3" stroke="#fff" stroke-width="2"/><circle cx="12" cy="13" r="3" stroke="#fff" stroke-width="2"/></svg> Run OCR';const U=document.createElement("div");U.className="ocr-status",D.appendChild(H),D.appendChild(U);let J=[];const w={zoom:1,rotateDeg:0,brightness:0,contrast:1,curIndex:0,sharpen:!1};let R=[];function bt(){const p=[];(Array.isArray(n.pdf_pages)&&n.pdf_pages.length?n.pdf_pages.slice():n.image_data?[n.image_data]:[]).forEach(function(f){p.push({kind:"primary",url:f})}),(Array.isArray(n.support_docs)?n.support_docs:[]).forEach(function(f){Array.isArray(f.pdf_pages)&&f.pdf_pages.length?f.pdf_pages.forEach(function(E){p.push({kind:"support",url:E,source:f})}):f.processed_url?p.push({kind:"support",url:f.processed_url,source:f}):f.original_url&&p.push({kind:"support",url:f.original_url,source:f})}),R=p,w.curIndex>=R.length&&(w.curIndex=Math.max(0,R.length-1))}function xt(){R.length>1?l.textContent=w.curIndex+1+" of "+R.length:l.textContent=""}function _t(p){try{if(!window.cv)return p;const x=cv.imread(p),S=new cv.Mat;cv.GaussianBlur(x,S,new cv.Size(0,0),1);const f=new cv.Mat;cv.addWeighted(x,1.5,S,-.5,0,f);const E=document.createElement("canvas");return E.width=f.cols,E.height=f.rows,cv.imshow(E,f),x.delete(),S.delete(),f.delete(),E}catch{return p}}function W(){const p=R[w.curIndex],x=p&&p.url;if(!x)return;const S=new Image;S.onload=function(){const f=S.naturalWidth,E=S.naturalHeight,C=w.zoom,L=w.rotateDeg*Math.PI/180,O=Math.cos(L),V=Math.sin(L),A=Math.abs(f*C*O)+Math.abs(E*C*V),z=Math.abs(f*C*V)+Math.abs(E*C*O);h.width=Math.max(1,Math.round(A)),h.height=Math.max(1,Math.round(z));const G=document.createElement("canvas");G.width=f,G.height=E;const B=G.getContext("2d");B.filter="contrast("+w.contrast+") brightness("+(1+w.brightness)+")",B.drawImage(S,0,0);let ut=G;w.sharpen&&(ut=_t(G)),v.save(),v.clearRect(0,0,h.width,h.height),v.translate(h.width/2,h.height/2),v.rotate(L),v.drawImage(ut,-f*C/2,-E*C/2,f*C,E*C),v.restore(),xt(),st.disabled=!(p&&p.kind==="support")},S.src=x}function Tt(p){J.forEach(function(x){p?x.input.classList.add("low-confidence"):x.input.classList.remove("low-confidence")})}P.addEventListener("click",function(){w.zoom=Math.min(4,w.zoom+.1),W()}),k.addEventListener("click",function(){w.zoom=Math.max(.2,w.zoom-.1),W()}),F.addEventListener("click",function(){w.rotateDeg=(w.rotateDeg-90)%360,W()}),T.addEventListener("click",function(){w.rotateDeg=(w.rotateDeg+90)%360,W()}),M.addEventListener("input",function(){w.contrast=parseFloat(M.value||"1"),W()}),y.addEventListener("input",function(){w.brightness=parseFloat(y.value||"0"),W()}),j.addEventListener("click",function(){w.sharpen=!w.sharpen,W()}),I.addEventListener("click",function(){w.zoom=1,w.rotateDeg=0,w.brightness=0,w.contrast=1,M.value="1.0",y.value="0.0",W()}),m.addEventListener("click",function(){R.length>1&&(w.curIndex=(w.curIndex-1+R.length)%R.length,W())}),g.addEventListener("click",function(){R.length>1&&(w.curIndex=(w.curIndex+1)%R.length,W())});const st=document.createElement("button");st.className="icon-btn",st.title="Remove Current",st.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="#111" stroke-width="2"/></svg>',st.addEventListener("click",function(){const p=R[w.curIndex];if(!p||p.kind!=="support")return;const x=Array.isArray(n.support_docs)?n.support_docs:[];let S=!1;for(let f=0;f<x.length;f++){const E=x[f];if(Array.isArray(E.pdf_pages)&&E.pdf_pages.indexOf(p.url)!==-1){x.splice(f,1),S=!0;break}if(E.processed_url===p.url||E.original_url===p.url){x.splice(f,1),S=!0;break}}if(S){if(!window.confirm("Remove this supporting document?"))return;n.support_docs=x;const E=K(),C=q(n),L=E.findIndex(function(O){return q(O)===C});L!==-1?E[L]=n:E.push(n),X(E),bt(),W()}}),bt(),r.appendChild(m),r.appendChild(l),r.appendChild(g),r.appendChild(st),s.appendChild(r),s.appendChild(d),s.appendChild(b),s.appendChild(D);const zt=document.createElement("div");zt.className="supporting-section";const St=document.createElement("div");St.className="supporting-header";const Lt=document.createElement("div");Lt.textContent="Supporting Documents";const Pt=document.createElement("div");Pt.className="supporting-actions";const rt=document.createElement("button");rt.className="icon-btn",rt.title="Upload Supporting Doc",rt.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M12 3v10" stroke="#111" stroke-width="2"/><path d="M8 7l4-4 4 4" stroke="#111" stroke-width="2"/><path d="M4 14v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4" stroke="#111" stroke-width="2"/></svg>';const ct=document.createElement("button");ct.className="icon-btn",ct.title="Capture Supporting Doc",ct.innerHTML='<svg viewBox="0 0 24 24" fill="none"><rect x="3" y="7" width="18" height="12" rx="3" stroke="#111" stroke-width="2"/><path d="M9 7l1.5-2h3L15 7" stroke="#111" stroke-width="2"/><circle cx="12" cy="13" r="3" stroke="#111" stroke-width="2"/></svg>';const et=document.createElement("input");et.type="file",et.accept="image/*,application/pdf",et.multiple=!0,et.style.display="none";const nt=document.createElement("input");nt.type="file",nt.accept="image/*",nt.setAttribute("capture","environment"),nt.style.display="none",r.appendChild(rt),r.appendChild(ct),St.appendChild(Lt),St.appendChild(Pt),r.appendChild(et),r.appendChild(nt);const Kt=document.createElement("div");Kt.className="supporting-list";function It(){bt()}function Ot(p){const x=Array.from(p||[]);if(!x.length)return;function S(C){const L=Array.isArray(n.support_docs)?n.support_docs:[];L.push(C),n.support_docs=L;const O=K(),V=q(n),A=O.findIndex(function(z){return q(z)===V});A!==-1?O[A]=n:O.push(n),X(O),It(),W(),xt()}function f(C){lt(function(){const L=document.createElement("img");L.src=URL.createObjectURL(C),L.onload=function(){const O=document.createElement("canvas");O.width=L.naturalWidth,O.height=L.naturalHeight,O.getContext("2d").drawImage(L,0,0);let A;try{const B=gt(L);A=B?at.extractPaper(L,B.resultWidth,B.resultHeight,B.cornerPoints):O}catch{A=O}const z=O.toDataURL("image/jpeg",.85),G=A.toDataURL("image/jpeg",.85);S({original_url:z,processed_url:G})}})}function E(C){Rt(async function(){const L=await C.arrayBuffer(),O=await window.pdfjsLib.getDocument({data:L}).promise,V=[];for(let A=1;A<=O.numPages;A++){const z=await O.getPage(A),G=z.getViewport({scale:1.6}),B=document.createElement("canvas"),ut=B.getContext("2d");B.width=Math.floor(G.width),B.height=Math.floor(G.height),await z.render({canvasContext:ut,viewport:G}).promise;let kt=B;try{const mt=gt(B);kt=mt?at.extractPaper(B,mt.resultWidth,mt.resultHeight,mt.cornerPoints):B}catch{kt=B}V.push(kt.toDataURL("image/jpeg",.85))}S({pdf_pages:V})})}x.forEach(function(C){/\.pdf$/i.test(C.name||"")||(C.type||"").toLowerCase()==="application/pdf"?E(C):f(C)})}rt.addEventListener("click",function(){et.click()}),ct.addEventListener("click",function(){nt.click()}),et.addEventListener("change",function(p){Ot(p.target.files)}),nt.addEventListener("change",function(p){Ot(p.target.files)}),It(),xt(),t.appendChild(s),W(),H.addEventListener("click",async function(){U.textContent="OCR: Processing…",Tt(!1);try{await new Promise(function(A){lt(A)}),await new Promise(function(A){ht(A)});let p=h;w.sharpen&&(p=_t(h));const x=vt(p),S=await window.Tesseract.recognize(x,"eng"),f=S.data.text,E=S.data&&typeof S.data.confidence=="number"?S.data.confidence:0,{endpoint:C,model:L,apiKey:O}=ot();if(!C||!L||!O){U.textContent="OCR: Error (LLM settings missing)",_("LLM settings missing. Set endpoint, model, and API key.");return}const V=await yt(C,L,O,f);if(V){const A=wt(V);J.forEach(function(z){z.input.value=A[z.key]==null?"":String(A[z.key])}),U.textContent="OCR: Success",Tt(E<65)}else U.textContent="OCR: Error (LLM parsing failed)",_("LLM parsing failed. Check model and endpoint settings.")}catch(p){U.textContent="OCR: Error",_("OCR error: "+(p&&p.message?p.message:String(p)))}}),Bt.forEach(function(p){const x=document.createElement("div");x.className="field";const S=document.createElement("label");S.textContent=p;let f;p==="type_claim"?(f=document.createElement("select"),Mt.forEach(function(E){const C=document.createElement("option");C.value=E,C.textContent=E,f.appendChild(C)}),f.value=n[p]==null?"":String(n[p])):(f=document.createElement("input"),p==="total_amount"&&(f.type="number",f.step="0.01"),f.value=n[p]==null?"":String(n[p])),x.appendChild(S),x.appendChild(f),s.appendChild(x),J.push({key:p,input:f})});const dt=document.createElement("div");dt.className="actions";const pt=document.createElement("button");pt.className="primary",pt.innerHTML='<svg viewBox="0 0 24 24" fill="none" style="width:18px;height:18px;vertical-align:middle;margin-right:6px"><path d="M5 4h12l2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" stroke="#fff" stroke-width="2"/><path d="M7 8h10" stroke="#fff" stroke-width="2"/></svg> Save';const Et=document.createElement("button");Et.innerHTML='<svg viewBox="0 0 24 24" fill="none" style="width:18px;height:18px;vertical-align:middle;margin-right:6px"><path d="M6 6l12 12M18 6L6 18" stroke="#111" stroke-width="2"/></svg> Close',dt.appendChild(pt),dt.appendChild(Et),s.appendChild(dt),pt.addEventListener("click",function(){J.forEach(function(f){n[f.key]=f.input.value});const p=K(),x=q(n),S=p.findIndex(function(f){return q(f)===x});S!==-1?p[S]=n:p.push(n),X(p),Q(),t.style.display="none"}),Et.addEventListener("click",function(){t.style.display="none"}),a.addEventListener("click",function(){t.style.display="none"}),c.addEventListener("click",function(){const p=q(n),x=K().filter(function(S){return q(S)!==p});X(x),Q(),t.style.display="none"})}Q();function ot(){try{return JSON.parse(localStorage.getItem(Ft)||"{}")}catch{return{}}}function Xt(n){localStorage.setItem(Ft,JSON.stringify(n))}$("#openSettings").on("click",function(){const n=ot();$("#settingsEndpoint").val(n.endpoint||"https://api.openai.com/v1/chat/completions"),$("#settingsModel").val(n.model||"gpt-4o-mini"),$("#settingsApiKey").val(n.apiKey||""),$("#settingsExtractHeight").val(n.extractHeight||"2000"),$("#settingsCamWidth").val(n.camWidth||"1920"),$("#settingsCamHeight").val(n.camHeight||"1080");const t=Wt();$("#settingsSmtpHost").val(t.host||""),$("#settingsSmtpPort").val(t.port||""),$("#settingsSmtpUser").val(t.user||""),$("#settingsSmtpPass").val(t.pass||""),$("#settingsSmtpFrom").val(t.from||""),$("#settingsSmtpTo").val(t.to||""),$("#settingsSmtpSubject").val(t.subject||"Receipts"),$("#settingsSmtpToken").val(t.token||""),$("#settingsEmailApiEndpoint").val(t.apiEndpoint||""),$("#settingsEmailApiKey").val(t.apiKey||""),$("#settingsPanel").show()});$("#closeSettings, #cancelSettings").on("click",function(){$("#settingsPanel").hide()});$("#saveSettings").on("click",function(){const n={endpoint:$("#settingsEndpoint").val(),model:$("#settingsModel").val(),apiKey:$("#settingsApiKey").val(),extractHeight:$("#settingsExtractHeight").val(),camWidth:$("#settingsCamWidth").val(),camHeight:$("#settingsCamHeight").val()};Xt(n);const t={host:$("#settingsSmtpHost").val(),port:$("#settingsSmtpPort").val(),user:$("#settingsSmtpUser").val(),pass:$("#settingsSmtpPass").val(),from:$("#settingsSmtpFrom").val(),to:$("#settingsSmtpTo").val(),subject:$("#settingsSmtpSubject").val(),token:$("#settingsSmtpToken").val(),apiEndpoint:$("#settingsEmailApiEndpoint").val(),apiKey:$("#settingsEmailApiKey").val()};Yt(t),$("#settingsPanel").hide()});$(document).on("click","#testSmtp",async function(){const n=document.getElementById("testSmtp");n&&(n.disabled=!0,n.textContent="Testing…");const t={host:$("#settingsSmtpHost").val(),port:$("#settingsSmtpPort").val(),user:$("#settingsSmtpUser").val(),pass:$("#settingsSmtpPass").val(),from:$("#settingsSmtpFrom").val(),to:$("#settingsSmtpTo").val(),subject:$("#settingsSmtpSubject").val(),token:$("#settingsSmtpToken").val(),apiEndpoint:$("#settingsEmailApiEndpoint").val(),apiKey:$("#settingsEmailApiKey").val()};if(!t.apiEndpoint&&!t.token&&(!t.host||!t.port||!t.user||!t.pass||!t.from||!t.to)){_("Fill Email API or SMTP settings"),n&&(n.disabled=!1,n.textContent="Test SMTP");return}showProcessing(),u("Testing SMTP settings");let e=!1;const i=setTimeout(function(){e||(_("SMTP library load timed out"),hideProcessing(),n&&(n.disabled=!1,n.textContent="Test SMTP"))},8e3);if(t.apiEndpoint){try{const o=new AbortController,a=setTimeout(function(){o.abort()},15e3),c={"Content-Type":"application/json"};t.apiKey&&(c.Authorization="Bearer "+t.apiKey);const s=await fetch(t.apiEndpoint,{method:"POST",headers:c,body:JSON.stringify({to:t.to,from:t.from,subject:(t.subject||"SMTP Test")+" (Test)",text:"This is a test email from Melvin Scanner."}),signal:o.signal});clearTimeout(a),hideProcessing(),n&&(n.disabled=!1,n.textContent="Test SMTP"),s.ok?_("Email API test succeeded"):_("Email API test failed: "+s.status)}catch{hideProcessing(),n&&(n.disabled=!1,n.textContent="Test SMTP"),_("Email API test error or timed out")}return}Ht(async function(){e=!0,clearTimeout(i);function o(s,d){return new Promise(function(r){let m=!1;function g(h){m||(m=!0,r(h))}const l=setTimeout(function(){g(!1)},d);try{window.Email.send(s).then(function(){clearTimeout(l),g(!0)}).catch(function(){clearTimeout(l),g(!1)})}catch{clearTimeout(l),g(!1)}})}const a=t.token?{SecureToken:t.token,To:t.to,From:t.from,Subject:(t.subject||"SMTP Test")+" (Test)",Body:"This is a test email from Melvin Scanner."}:{Host:t.host,Port:t.port,Username:t.user,Password:t.pass,To:t.to,From:t.from,Subject:(t.subject||"SMTP Test")+" (Test)",Body:"This is a test email from Melvin Scanner."};await o(a,2e4)?(u("SMTP test succeeded"),_("SMTP test succeeded")):(u("SMTP test failed or timed out"),_("SMTP test failed or timed out")),hideProcessing(),n&&(n.disabled=!1,n.textContent="Test SMTP")})});async function te(n){u("Loading PDF: "+(n.name||"blob"));const t=await n.arrayBuffer(),e=await window.pdfjsLib.getDocument({data:t}).promise;u("PDF pages: "+e.numPages);const i=[],{endpoint:o,model:a,apiKey:c}=ot();let s="";for(let r=1;r<=e.numPages;r++){const m=await e.getPage(r),g=m.getViewport({scale:1.6}),l=document.createElement("canvas"),h=l.getContext("2d");l.width=Math.floor(g.width),l.height=Math.floor(g.height),await m.render({canvasContext:h,viewport:g}).promise;const v=Ct(l);if(i.push(v),u("Rendered page "+r+"/"+e.numPages),o&&a&&c){await new Promise(function(P){ht(P)}),u("Enhancing image for OCR");const b=vt(l),k=await window.Tesseract.recognize(b,"eng");s+=(k.data.text||"")+`

`,u("OCR page "+r)}}let d;if(o&&a&&c){u("Calling LLM for PDF");const r=await yt(o,a,c,s),m=r?wt(r):{};d=it(m,void 0,i[0]),r||(d.status="unsuccessful")}else d=it({},void 0,i[0]),d.status="pending";d.page_count=e.numPages,d.pdf_pages=i,ft([d]),Q(),u("Saved PDF claim with "+e.numPages+" page(s)")}
